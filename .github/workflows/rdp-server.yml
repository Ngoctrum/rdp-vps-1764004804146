name: üöÄ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host "ü§ñ AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          function New-PremiumPassword {
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers
              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]
              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }
              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }
          $matKhau = New-PremiumPassword
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AISTV-PREMIUM"
          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt

      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Write-Host "üì• Downloading Tailscale..." -ForegroundColor Yellow
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Write-Host "üì¶ Installing Tailscale..." -ForegroundColor Yellow
          Start-Process msiexec.exe -ArgumentList "/i", "\`"$msiPath\`"", "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 15
          $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $maxRetries = 30
          $retryCount = 0
          Write-Host "‚è≥ Ch·ªù c√†i ƒë·∫∑t ho√†n t·∫•t..." -ForegroundColor Cyan
          while (-not (Test-Path $tailscalePath) -and $retryCount -lt $maxRetries) {
              Write-Host "üîÑ ƒêang ch·ªù... ($retryCount/$maxRetries)" -ForegroundColor Cyan
              Start-Sleep -Seconds 2
              $retryCount++
          }
          if (-not (Test-Path $tailscalePath)) {
              Write-Host "‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y Tailscale sau khi c√†i ƒë·∫∑t" -ForegroundColor Red
              throw "Tailscale installation failed - executable not found"
          }
          Write-Host "‚úÖ Tailscale ƒë√£ c√†i ƒë·∫∑t th√†nh c√¥ng!" -ForegroundColor Green
          Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
          Write-Host "üîó ƒêang k·∫øt n·ªëi Tailscale network..." -ForegroundColor Yellow
          & $tailscalePath up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          Start-Sleep -Seconds 5
          Write-Host "üîÑ ƒêang l·∫•y ƒë·ªãa ch·ªâ IP..." -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              $ip = & $tailscalePath ip -4 2>&1
              if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                  Write-Host "‚úÖ ƒê·ªãa ch·ªâ IP: $ip" -ForegroundColor Green
                  echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                  echo "TAILSCALE_INSTALLED=true" >> $env:GITHUB_ENV
                  break
              }
              Write-Host "‚è≥ Ch·ªù IP address... ($i/20)" -ForegroundColor Cyan
              Start-Sleep -Seconds 3
          }
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
              Write-Host "‚ùå Kh√¥ng th·ªÉ l·∫•y IP sau 60 gi√¢y" -ForegroundColor Red
              throw "Failed to get Tailscale IP address"
          }

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60; $displayTime = "1 gi·ªù" }
              "3h" { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "5h40m" { $totalMinutes = 340; $displayTime = "5 gi·ªù 40 ph√∫t" }
          }
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ üéâ K·∫æT N·ªêI TH√ÄNH C√îNG! ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê ƒê·ªãa ch·ªâ: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "‚îÇ üë§ T√†i kho·∫£n: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "‚îÇ üîê M·∫≠t kh·∫©u: $matKhau" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞ Th·ªùi l∆∞·ª£ng: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üìç Port: 3389" -ForegroundColor White
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMinutes = $env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          do {
              $thoiGianHienTai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $thoiGianConLai = $thoiGianKetThuc - $thoiGianHienTai
              $gioConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalHours))
              $phutConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalMinutes % 60))
              $giayConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalSeconds % 60))
              Write-Host "[$($thoiGianHienTai.ToString('HH:mm:ss'))] Th·ªùi gian c√≤n l·∫°i: $gioConLai gi·ªù $phutConLai ph√∫t $giayConLai gi√¢y" -ForegroundColor Blue
              Start-Sleep -Seconds 30
          } while ($thoiGianConLai.TotalSeconds -gt 0)
          Write-Host "üéØ ƒê√É H·∫æT TH·ªúI GIAN - T·ª∞ ƒê·ªòNG D·ª™NG!" -ForegroundColor Red

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          if ($env:TAILSCALE_INSTALLED -eq "true") {
              $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
              if (Test-Path $tailscalePath) {
                  & $tailscalePath down --accept-risk=all -ErrorAction SilentlyContinue
              }
          }
          netsh advfirewall firewall delete rule name="RDP-Premium" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
